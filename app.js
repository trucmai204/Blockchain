const contractABI = [
    {
      "inputs": [],
      "stateMutability": "nonpayable",
      "type": "constructor"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "classId",
          "type": "uint256"
        },
        {
          "indexed": true,
          "internalType": "address",
          "name": "user",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "bool",
          "name": "isPresent",
          "type": "bool"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "timestamp",
          "type": "uint256"
        }
      ],
      "name": "AttendanceMarked",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "classId",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "string",
          "name": "name",
          "type": "string"
        },
        {
          "indexed": false,
          "internalType": "address",
          "name": "teacher",
          "type": "address"
        }
      ],
      "name": "ClassCreated",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "classId",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "address",
          "name": "student",
          "type": "address"
        }
      ],
      "name": "StudentAdded",
      "type": "event"
    },
    {
      "inputs": [],
      "name": "classCount",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "classes",
      "outputs": [
        {
          "internalType": "string",
          "name": "name",
          "type": "string"
        },
        {
          "internalType": "address",
          "name": "teacher",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "owner",
      "outputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "string",
          "name": "_name",
          "type": "string"
        }
      ],
      "name": "createClass",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_classId",
          "type": "uint256"
        },
        {
          "internalType": "address",
          "name": "_student",
          "type": "address"
        }
      ],
      "name": "addStudent",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_classId",
          "type": "uint256"
        },
        {
          "internalType": "bool",
          "name": "_isPresent",
          "type": "bool"
        }
      ],
      "name": "markAttendance",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_classId",
          "type": "uint256"
        },
        {
          "internalType": "address",
          "name": "_student",
          "type": "address"
        }
      ],
      "name": "getAttendanceCount",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_classId",
          "type": "uint256"
        },
        {
          "internalType": "address",
          "name": "_student",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "index",
          "type": "uint256"
        }
      ],
      "name": "getAttendanceRecord",
      "outputs": [
        {
          "internalType": "bool",
          "name": "",
          "type": "bool"
        },
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_classId",
          "type": "uint256"
        }
      ],
      "name": "getStudents",
      "outputs": [
        {
          "internalType": "address[]",
          "name": "",
          "type": "address[]"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "getTotalClasses",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    }
  ];
  const contractAddress = "0xbB6dfDc18B6CfA61DD75028aDb2687FF566BC2B5";

  let web3;
  let contract;
  let accounts;
  
  // Khi t√†i li·ªáu HTML ƒë√£ t·∫£i xong
  document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("connectWallet")?.addEventListener("click", connectWallet);
      document.getElementById("createClass")?.addEventListener("click", createClass);
      document.getElementById("addStudent")?.addEventListener("click", addStudent);
      document.getElementById("markAttendance")?.addEventListener("click", markAttendance);
      document.getElementById("viewAttendance")?.addEventListener("click", viewAttendance);
  });
  
  async function connectWallet() {
      if (window.ethereum) {
          try {
              console.log("üîó K·∫øt n·ªëi MetaMask...");
              web3 = new Web3(window.ethereum);
              await window.ethereum.request({ method: "eth_requestAccounts" });
              accounts = await web3.eth.getAccounts();
              console.log("‚úÖ ƒê√£ k·∫øt n·ªëi v·ªõi t√†i kho·∫£n:", accounts[0]);
  
              document.getElementById("walletAddress").innerText = `üü¢ ƒê√£ k·∫øt n·ªëi: ${accounts[0]}`;
              contract = new web3.eth.Contract(contractABI, contractAddress);
              console.log("üìú H·ª£p ƒë·ªìng ƒë√£ t·∫£i:", contract);
  
              await loadClasses();
          } catch (error) {
              console.error("‚ùå L·ªói khi k·∫øt n·ªëi MetaMask:", error);
          }
      } else {
          alert("‚ö†Ô∏è B·∫°n c·∫ßn c√†i MetaMask ƒë·ªÉ s·ª≠ d·ª•ng!");
      }
  }
  
  async function createClass() {
      const name = document.getElementById("className")?.value.trim();
      if (!name) return alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n l·ªõp!");
      
      try {
          await contract.methods.createClass(name).send({ from: accounts[0] });
          alert("‚úÖ L·ªõp h·ªçc ƒë√£ ƒë∆∞·ª£c t·∫°o!");
          await loadClasses();
      } catch (error) {
          console.error("‚ùå L·ªói khi t·∫°o l·ªõp:", error);
      }
  }
  
  async function loadClasses() {
      const classList = document.getElementById("classList");
      const classListForAddingStudent = document.getElementById("classListForAddingStudent");
      
      if (!classList || !classListForAddingStudent) {
          console.error("‚ùå Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ danh s√°ch l·ªõp!");
          return;
      }
      
      classList.innerHTML = "";
      classListForAddingStudent.innerHTML = "";
  
      try {
          const classCount = await contract.methods.classCount().call();
          for (let i = 1; i <= classCount; i++) {
              const classData = await contract.methods.classes(i).call();
              const option = new Option(`${classData.name} - GV: ${classData.teacher}`, i);
              classList.appendChild(option);
              classListForAddingStudent.appendChild(option.cloneNode(true));
          }
      } catch (error) {
          console.error("‚ùå L·ªói khi t·∫£i danh s√°ch l·ªõp:", error);
      }
  }
  
  async function addStudent() {
      const classId = document.getElementById("classListForAddingStudent")?.value;
      const studentAddress = document.getElementById("studentAddress")?.value.trim();
      if (!studentAddress) return alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ v√≠ c·ªßa h·ªçc sinh!");
      
      try {
          await contract.methods.addStudent(classId, studentAddress).send({ from: accounts[0] });
          alert("‚úÖ H·ªçc sinh ƒë√£ ƒë∆∞·ª£c th√™m v√†o l·ªõp!");
      } catch (error) {
          console.error("‚ùå L·ªói khi th√™m h·ªçc sinh:", error);
      }
  }
  
  async function markAttendance() {
      const classId = document.getElementById("classList")?.value;
      if (!classId) return alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn l·ªõp h·ªçc!");
      
      try {
          await contract.methods.markAttendance(classId, true)
              .send({ from: accounts[0] })
              .on("receipt", () => alert("‚úÖ ƒêi·ªÉm danh th√†nh c√¥ng!"));
      } catch (error) {
          console.error("‚ùå L·ªói khi ƒëi·ªÉm danh:", error);
      }
  }
  
  async function viewAttendance() {
      try {
          const history = document.getElementById("attendanceHistory");
          history.innerHTML = "";
  
          const studentAddress = accounts[0];
          console.log("üìå ƒê·ªãa ch·ªâ sinh vi√™n:", studentAddress);
  
          if (!studentAddress) {
              alert("‚ùå Vui l√≤ng k·∫øt n·ªëi MetaMask tr∆∞·ªõc khi xem l·ªãch s·ª≠ ƒëi·ªÉm danh.");
              return;
          }
  
          const totalClasses = Number(await contract.methods.getTotalClasses().call());
          console.log("üìå T·ªïng s·ªë l·ªõp:", totalClasses);
  
          for (let i = 1; i <= totalClasses; i++) {
              const attendanceCount = await contract.methods.getAttendanceCount(i, studentAddress).call();
              
              for (let j = 0; j < attendanceCount; j++) {
                  const record = await contract.methods.getAttendanceRecord(i, studentAddress, j).call();
                  const li = document.createElement("li");
                  li.innerText = `üìö M√¥n ${i}: ${record[0] ? "‚úÖ C√≥ m·∫∑t" : "‚ùå V·∫Øng"} - ${new Date(Number(record[1]) * 1000).toLocaleString()}`;
                  history.appendChild(li);
              }
          }
      } catch (error) {
          console.error("‚ùå L·ªói khi xem l·ªãch s·ª≠ ƒëi·ªÉm danh:", error);
      }
  }


